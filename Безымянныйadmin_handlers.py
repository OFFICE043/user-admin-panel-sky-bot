# handlers/admin_handlers.py
import logging
import datetime
from telegram import Update
from telegram.ext import (
    Application,
    ContextTypes,
    ConversationHandler,
    MessageHandler,
    filters,
    CommandHandler,
)
from telegram.constants import ParseMode

# –ñ–æ–±–∞–Ω—ã“£ –±–∞—Å“õ–∞ —Ñ–∞–π–ª–¥–∞—Ä—ã–Ω–∞–Ω –∏–º–ø–æ—Ä—Ç—Ç–∞—É
import database
from keyboards import admin_keyboards, user_keyboards
from config import SUPER_ADMINS

# –õ–æ–≥–≥–µ—Ä–¥—ñ –æ—Ä–Ω–∞—Ç—É
logger = logging.getLogger(__name__)

# ConversationHandler –∫“Ø–π–ª–µ—Ä—ñ
(
    # Anime Panel
    ANIME_UPLOAD_DATA, ANIME_EDIT_CODE, ANIME_EDIT_NEW_DATA, ANIME_DELETE_CODE,
    # Settings Panel
    VIP_DESC_EDIT, VIP_PRICE_EDIT, GIVE_VIP_DATA, REMOVE_VIP_ID,
    # Admin Management
    ADD_ADMIN_ID, REMOVE_ADMIN_ID,
    # Broadcast
    BROADCAST_MESSAGE,
) = range(12)


# --- –ö”®–ú–ï–ö–®–Ü –§–£–ù–ö–¶–ò–Ø–õ–ê–† ---

async def is_admin(user_id: int) -> bool:
    """–ü–∞–π–¥–∞–ª–∞–Ω—É—à—ã–Ω—ã“£ –∞–¥–º–∏–Ω –µ–∫–µ–Ω—ñ–Ω —Ç–µ–∫—Å–µ—Ä–µ–¥—ñ."""
    return database.get_user_role(user_id) == 'admin'

async def is_super_admin(user_id: int) -> bool:
    """–ü–∞–π–¥–∞–ª–∞–Ω—É—à—ã–Ω—ã“£ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω –µ–∫–µ–Ω—ñ–Ω —Ç–µ–∫—Å–µ—Ä–µ–¥—ñ."""
    return user_id in SUPER_ADMINS


# --- –ù–ï–ì–Ü–ó–ì–Ü –ù–ê–í–ò–ì–ê–¶–ò–Ø ---

async def to_admin_panel(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–ù–µ–≥—ñ–∑–≥—ñ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—ñ–Ω–µ –æ—Ä–∞–ª—É (–¥–∏–∞–ª–æ–≥—Ç–∞—Ä “Ø—à—ñ–Ω –¥–µ)."""
    if not await is_admin(update.effective_user.id): return ConversationHandler.END
    await update.message.reply_text("üëÆ Asosiy admin panelidasiz.", reply_markup=admin_keyboards.get_admin_main_keyboard())
    return ConversationHandler.END

async def switch_to_user_panel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not await is_admin(update.effective_user.id): return
    await update.message.reply_text(
        "üë§ Siz hozir oddiy foydalanuvchi panelidasiz.\n"
        "Admin paneliga qaytish uchun /start buyrug'ini bosing.",
        reply_markup=user_keyboards.get_main_menu_keyboard()
    )


# --- ANIME PANEL –ë”®–õ–Ü–ú–Ü ---

async def to_anime_panel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not await is_admin(update.effective_user.id): return
    await update.message.reply_text("üé¨ Anime Boshqaruv Paneli", reply_markup=admin_keyboards.get_anime_panel_keyboard())

# 1. –ê–Ω–∏–º–µ –∂“Ø–∫—Ç–µ—É
async def anime_upload_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    await update.message.reply_text(
        "Anime yuklash uchun ma'lumotlarni bitta xabarda, probel bilan ajratib yozing:\n\n"
        "`kodi kanal_username post_id qismlar_soni anime_nomi`\n\n"
        "Masalan: `A001 @server 123 12 Naruto`",
        parse_mode=ParseMode.MARKDOWN_V2, reply_markup=admin_keyboards.get_back_to_admin_panel_keyboard()
    )
    return ANIME_UPLOAD_DATA

async def anime_upload_receive(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    try:
        data = update.message.text.split(maxsplit=4)
        code, channel, post_id, episodes, name = data
        success = database.add_anime(code, name, channel, int(post_id), int(episodes))
        if success:
            await update.message.reply_text(f"‚úÖ '{name}' nomli anime muvaffaqiyatli qo'shildi!", reply_markup=admin_keyboards.get_anime_panel_keyboard())
        else:
            await update.message.reply_text("‚ùå Xatolik: Bunday kodli anime allaqachon mavjud! Boshqa kod kiriting.")
            return ANIME_UPLOAD_DATA
    except (ValueError, IndexError):
        await update.message.reply_text("‚ùå Xatolik: Ma'lumotlar noto'g'ri formatda kiritildi.", reply_markup=admin_keyboards.get_anime_panel_keyboard())
        return ANIME_UPLOAD_DATA
    return await to_admin_panel(update, context)

# 2. –ê–Ω–∏–º–µ —Ç—ñ–∑—ñ–º—ñ
async def anime_list(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not await is_admin(update.effective_user.id): return
    animes = database.get_all_animes()
    if not animes:
        await update.message.reply_text("Hozircha animelar mavjud emas.")
        return
    text = "üìö Barcha animelar ro'yxati (kod - nom):\n\n"
    for i, anime in enumerate(animes, 1):
        text += f"{i}. `{anime[1]}` - {anime[2]}\n"
    await update.message.reply_text(text, parse_mode=ParseMode.MARKDOWN_V2)

# 3. –ê–Ω–∏–º–µ ”©—à—ñ—Ä—É
async def anime_delete_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    await anime_list(update, context)
    await update.message.reply_text("O'chirmoqchi bo'lgan anime kodini kiriting:", reply_markup=admin_keyboards.get_back_to_admin_panel_keyboard())
    return ANIME_DELETE_CODE

async def anime_delete_receive(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    code_to_delete = update.message.text.upper()
    success = database.delete_anime(code_to_delete)
    if success:
        await update.message.reply_text(f"‚úÖ `{code_to_delete}` kodli anime muvaffaqiyatli o'chirildi.")
    else:
        await update.message.reply_text(f"‚ùå `{code_to_delete}` kodli anime topilmadi.")
    return await to_admin_panel(update, context)


# --- SOZLAMALAR PANEL –ë”®–õ–Ü–ú–Ü ---

async def to_settings_panel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not await is_admin(update.effective_user.id): return
    await update.message.reply_text("‚öôÔ∏è Sozlamalar Boshqaruv Paneli", reply_markup=admin_keyboards.get_settings_panel_keyboard())

# 1. VIP —Å–∏–ø–∞—Ç—Ç–∞–º–∞—Å—ã–Ω ”©–∑–≥–µ—Ä—Ç—É
async def vip_desc_edit_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    current_desc = database.get_setting('vip_description')
    await update.message.reply_text(
        f"Hozirgi VIP tavsifi:\n\n{current_desc}\n\nIltimos, yangi tavsif matnini yuboring:",
        reply_markup=admin_keyboards.get_back_to_admin_panel_keyboard()
    )
    return VIP_DESC_EDIT

async def vip_desc_edit_receive(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    new_desc = update.message.text
    database.set_setting('vip_description', new_desc)
    await update.message.reply_text("‚úÖ VIP tavsifi muvaffaqiyatli yangilandi.")
    return await to_admin_panel(update, context)

# 2. VIP –±–µ—Ä—É
async def give_vip_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    await update.message.reply_text(
        "VIP status bermoqchi bo'lgan foydalanuvchi ID sini va kunlar sonini probel bilan ajratib yozing.\n\n"
        "Masalan: `123456789 30` (30 kunga VIP berish)",
        parse_mode=ParseMode.MARKDOWN_V2, reply_markup=admin_keyboards.get_back_to_admin_panel_keyboard()
    )
    return GIVE_VIP_DATA

async def give_vip_receive(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    try:
        user_id_str, days_str = update.message.text.split()
        user_id = int(user_id_str)
        days = int(days_str)
        success = database.set_user_role(user_id, 'vip', days)
        if success:
            await update.message.reply_text(f"‚úÖ Foydalanuvchi {user_id} ga {days} kunga VIP status berildi.")
            # –ü–∞–π–¥–∞–ª–∞–Ω—É—à—ã“ì–∞ —Ö–∞–±–∞—Ä –∂—ñ–±–µ—Ä—É
            await context.bot.send_message(user_id, f"Tabriklaymiz! Sizga {days} kunlik VIP status berildi!")
        else:
            await update.message.reply_text("‚ùå Foydalanuvchiga VIP berishda xatolik yuz berdi.")
    except (ValueError, IndexError):
        await update.message.reply_text("‚ùå Ma'lumotlar noto'g'ri formatda kiritildi. Qayta urinib ko'ring.")
        return GIVE_VIP_DATA
    return await to_admin_panel(update, context)


# --- ADMIN BOSHQARISH –ë”®–õ–Ü–ú–Ü ---

async def to_admin_management_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not await is_super_admin(update.effective_user.id):
        await update.message.reply_text("Bu bo'lim faqat Bosh Adminlar uchun.")
        return
    await update.message.reply_text("üëÆ Adminlarni Boshqarish", reply_markup=admin_keyboards.get_admin_manage_keyboard())

# ... (–ê–¥–º–∏–Ω “õ–æ—Å—É, ”©—à—ñ—Ä—É —Ñ—É–Ω–∫—Ü–∏—è–ª–∞—Ä—ã) ...


# --- BROADCAST (–•–ê–ë–ê–† –ñ–Ü–ë–ï–†–£) –ë”®–õ–Ü–ú–Ü ---

async def broadcast_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    if not await is_admin(update.effective_user.id): return ConversationHandler.END
    await update.message.reply_text(
        "Barcha foydalanuvchilarga yuborish uchun xabarni (matn, rasm, video va hokazo) yuboring:",
        reply_markup=admin_keyboards.get_back_to_admin_panel_keyboard()
    )
    return BROADCAST_MESSAGE

async def broadcast_receive(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    user_ids = database.get_all_user_ids()
    message_to_send = update.message
    
    await update.message.reply_text(f"Xabar yuborish boshlandi... Jami: {len(user_ids)} foydalanuvchi.")
    
    sent_count = 0
    failed_count = 0
    for user_id in user_ids:
        try:
            await context.bot.copy_message(chat_id=user_id, from_chat_id=message_to_send.chat_id, message_id=message_to_send.message_id)
            sent_count += 1
        except Exception as e:
            failed_count += 1
            logger.error(f"Foydalanuvchi {user_id} ga xabar yuborib bo'lmadi: {e}")

    await update.message.reply_text(f"‚úÖ Xabar yuborish yakunlandi.\nMuvaffaqiyatli: {sent_count}\nXatolik: {failed_count}")
    return await to_admin_panel(update, context)


# --- –ë–ê–†–õ–´“ö ADMIN –•–ï–ù–î–õ–ï–†–õ–ï–†–Ü–ù –¢–Ü–†–ö–ï–ô–¢–Ü–ù –§–£–ù–ö–¶–ò–Ø ---

def register_admin_handlers(application: Application):
    """–ë–∞—Ä–ª—ã“õ Admin Panel —Ö–µ–Ω–¥–ª–µ—Ä–ª–µ—Ä—ñ–Ω application-“ì–∞ —Ç—ñ—Ä–∫–µ–π–¥—ñ."""
    
    # Conversation Handlers
    anime_upload_conv = ConversationHandler(
        entry_points=[MessageHandler(filters.Regex("^üé¨ Anime Yuklash$"), anime_upload_start)],
        states={ANIME_UPLOAD_DATA: [MessageHandler(filters.TEXT & ~filters.COMMAND, anime_upload_receive)]},
        fallbacks=[MessageHandler(filters.Regex("^‚¨ÖÔ∏è Orqaga \(Admin Panel\)$"), to_admin_panel)]
    )
    anime_delete_conv = ConversationHandler(
        entry_points=[MessageHandler(filters.Regex("^‚ùå Kodni o'chirish$"), anime_delete_start)],
        states={ANIME_DELETE_CODE: [MessageHandler(filters.TEXT & ~filters.COMMAND, anime_delete_receive)]},
        fallbacks=[MessageHandler(filters.Regex("^‚¨ÖÔ∏è Orqaga \(Admin Panel\)$"), to_admin_panel)]
    )
    vip_desc_conv = ConversationHandler(
        entry_points=[MessageHandler(filters.Regex("^üìù VIP Tavsifini Tahrirlash$"), vip_desc_edit_start)],
        states={VIP_DESC_EDIT: [MessageHandler(filters.TEXT & ~filters.COMMAND, vip_desc_edit_receive)]},
        fallbacks=[MessageHandler(filters.Regex("^‚¨ÖÔ∏è Orqaga \(Admin Panel\)$"), to_admin_panel)]
    )
    give_vip_conv = ConversationHandler(
        entry_points=[MessageHandler(filters.Regex("^‚ûï Foydalanuvchiga VIP Berish$"), give_vip_start)],
        states={GIVE_VIP_DATA: [MessageHandler(filters.TEXT & ~filters.COMMAND, give_vip_receive)]},
        fallbacks=[MessageHandler(filters.Regex("^‚¨ÖÔ∏è Orqaga \(Admin Panel\)$"), to_admin_panel)]
    )
    broadcast_conv = ConversationHandler(
        entry_points=[MessageHandler(filters.Regex("^üì¨ Habar Yuborish$"), broadcast_start)],
        states={BROADCAST_MESSAGE: [MessageHandler(filters.ALL & ~filters.COMMAND, broadcast_receive)]},
        fallbacks=[MessageHandler(filters.Regex("^‚¨ÖÔ∏è Orqaga \(Admin Panel\)$"), to_admin_panel)]
    )

    admin_handlers = [
        anime_upload_conv,
        anime_delete_conv,
        vip_desc_conv,
        give_vip_conv,
        broadcast_conv,
        MessageHandler(filters.Regex("^üé¨ Anime Panel$"), to_anime_panel),
        MessageHandler(filters.Regex("^‚öôÔ∏è Sozlamalar Panel$"), to_settings_panel),
        MessageHandler(filters.Regex("^üìö Kodlar Ro'yxati$"), anime_list),
        MessageHandler(filters.Regex("^üëÆ Admin Boshqarish$"), to_admin_management_menu),
        MessageHandler(filters.Regex("^üë§ User Panelga o'tish$"), switch_to_user_panel),
        MessageHandler(filters.Regex("^‚¨ÖÔ∏è Orqaga \(Admin Panel\)$"), to_admin_panel),
    ]

    # –ë–∞—Ä–ª—ã“õ –∞–¥–º–∏–Ω —Ö–µ–Ω–¥–ª–µ—Ä–ª–µ—Ä—ñ–Ω —Ç–µ–∫ –∞–¥–º–∏–Ω–¥–µ—Ä–≥–µ “ì–∞–Ω–∞ –∂“±–º—ã—Å —ñ—Å—Ç–µ–π—Ç—ñ–Ω–¥–µ–π –µ—Ç—ñ–ø —Ç—ñ—Ä–∫–µ—É
    for handler in admin_handlers:
        application.add_handler(handler)

    logger.info("Admin panel handler-lari muvaffaqiyatli o'rnatildi.")
